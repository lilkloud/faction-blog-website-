{% extends "base.html" %}
{% from "macros/formhelpers.html" import render_field, render_checkbox_field %}

{% block title %}Edit Profile - Style & Grace{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
                <div class="card-header bg-light py-3">
                    <h2 class="h5 mb-0">Edit Profile</h2>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="row mb-4">
                            <div class="col-md-4 text-center">
                                <div class="mb-3">
                                    <img id="avatar-preview" 
                                         src="{{ url_for('static', filename='profile_pics/' + current_user.image_file) }}" 
                                         class="img-thumbnail rounded-circle" 
                                         alt="Profile Picture"
                                         style="width: 150px; height: 150px; object-fit: cover;">
                                </div>
                                <div class="mb-3">
                                    {{ form.picture.label(class="form-label") }}
                                    {{ form.picture(class="form-control" + (' is-invalid' if form.picture.errors else ''), 
                                                  onchange="previewImage(this, 'avatar-preview')") }}
                                    {% if form.picture.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.picture.errors %}
                                                <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="form-text">JPG, JPEG or PNG (max 5MB)</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        {{ render_field(form.username, placeholder="Enter your username") }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ render_field(form.email, placeholder="Enter your email") }}
                                    </div>
                                    <div class="col-12">
                                        {{ render_field(form.about_me, rows=4, 
                                                      placeholder="Tell us about yourself...") }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ render_field(form.location, placeholder="Your location") }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ render_field(form.website, placeholder="https://yourwebsite.com") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('user.profile', username=current_user.username) }}" 
                               class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-1"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Change Password Card -->
            <div class="card shadow-sm border-0 rounded-4 overflow-hidden mt-4">
                <div class="card-header bg-light py-3">
                    <h3 class="h5 mb-0">Change Password</h3>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('user.change_password') }}" novalidate>
                        {{ password_form.hidden_tag() }}
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                {{ render_field(password_form.current_password, 
                                             placeholder="Current password") }}
                            </div>
                            <div class="col-md-4">
                                {{ render_field(password_form.new_password, 
                                             placeholder="New password") }}
                            </div>
                            <div class="col-md-4">
                                {{ render_field(password_form.confirm_password, 
                                             placeholder="Confirm new password") }}
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-key me-1"></i> Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Danger Zone -->
            <div class="card border-danger mt-4">
                <div class="card-header bg-danger text-white">
                    <h3 class="h5 mb-0">Danger Zone</h3>
                </div>
                <div class="card-body">
                    <h4 class="h6 text-danger">Delete Account</h4>
                    <p class="small text-muted">
                        Once you delete your account, there is no going back. Please be certain.
                    </p>
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" 
                            data-bs-target="#deleteAccountModal">
                        <i class="bi bi-trash me-1"></i> Delete My Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAccountModalLabel">Delete Your Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete your account? This action cannot be undone.</p>
                <p class="text-danger">All your posts, comments, and account data will be permanently removed.</p>
                <form id="deleteAccountForm" action="{{ url_for('user.delete_account') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="confirmUsername" class="form-label">
                            Type your username <strong>{{ current_user.username }}</strong> to confirm:
                        </label>
                        <input type="text" class="form-control" id="confirmUsername" name="confirm_username" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                        <label class="form-check-label" for="confirmDelete">
                            I understand that this action cannot be undone
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deleteAccountForm" class="btn btn-danger" id="deleteAccountBtn" disabled>
                    <i class="bi bi-trash me-1"></i> Delete My Account
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Enable/disable delete account button based on confirmation
    const confirmUsername = document.getElementById('confirmUsername');
    const confirmDelete = document.getElementById('confirmDelete');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const currentUsername = '{{ current_user.username }}';
    
    function validateDeleteConfirmation() {
        const usernameMatch = confirmUsername.value === currentUsername;
        const isChecked = confirmDelete.checked;
        deleteAccountBtn.disabled = !(usernameMatch && isChecked);
    }
    
    confirmUsername.addEventListener('input', validateDeleteConfirmation);
    confirmDelete.addEventListener('change', validateDeleteConfirmation);
    
    // Image preview function
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onloadend = function() {
            preview.src = reader.result;
        }
        
        if (file) {
            reader.readAsDataURL(file);
        } else {
            preview.src = '';
        }
    }
    
    // Initialize form validation
    (function () {
        'use strict'
        
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')
        
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    
                    form.classList.add('was-validated')
                }, false)
            })
    })()
</script>
{% endblock %}
